<p>
  Checkout
</p>

<%= form_for :checkout, url: checkouts_url, method: :post, id: "payment-form" do |f| %>
  <%= f.hidden_field :nonce %>
  <section>
    <label for="amount">
      <span class="input-label">Amount</span>
      <div class="input-wrapper amount-wrapper">
        <%= number_to_currency @order.amount %>
      </div>
    </label>

    <fieldset>
      <legend>Biling</legend>

      <%= fields_for :billing do |b| %>
        <label for="company">
          <span class="input-label">Company</span>
          <div class="input-wrapper">
            <%= b.text_field :company %>
          </div>
        </label>
        <label for="phone">
          <span class="input-label">Phone</span>
          <div class="input-wrapper">
            <%= b.text_field :phone %>
          </div>
        </label>
        <label for="email">
          <span class="input-label">Email</span>
          <div class="input-wrapper">
            <%= b.text_field :email %>
          </div>
        </label>
        <label for="phone">
          <span class="input-label">Phone</span>
          <div class="input-wrapper">
            <%= b.text_field :phone %>
          </div>
        </label>
        <label for="state">
          <span class="input-label">State</span>
          <div class="input-wrapper">
            <%= b.text_field :state %>
          </div>
        </label>
        <label for="first_name">
          <span class="input-label">First Name</span>
          <div class="input-wrapper">
            <%= b.text_field :first_name %>
          </div>
        </label>
        <label for="last_name">
          <span class="input-label">Last Name</span>
          <div class="input-wrapper">
            <%= b.text_field :last_name %>
          </div>
        </label>
      <% end %>
    </fieldset>

    <div class="bt-drop-in-wrapper">
      <div id="bt-dropin"></div>
    </div>
  </section>

  <button class="button" type="submit"><span>Test Transaction</span></button>
<% end %>

<script src="https://js.braintreegateway.com/web/dropin/1.25.0/js/dropin.min.js"></script>
<script>
  var form = document.querySelector('#payment-form');
  var client_token = "<%= @client_token %>";

  braintree.dropin.create({
    authorization: client_token,
    container: '#bt-dropin',
    vaultManager: true,
    paypal: {
      flow: 'vault'
    }
  }, function (createErr, instance) {
    form.addEventListener('submit', function (event) {
      event.preventDefault();

      instance.requestPaymentMethod(function (err, payload) {
        if (err) {
          console.log('Error', err);
          return;
        }

        document.querySelector('#nonce').value = payload.nonce;
        form.submit();
      });
    });
  });
</script>
<%= javascript_include_tag 'application', 'data-turbolinks-suppress-warning' => true, 'data-turbolinks-track' => true %>
